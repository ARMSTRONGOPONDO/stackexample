-- User profiles table (extends Supabase auth.users)
CREATE TABLE user_profiles (
  id UUID REFERENCES auth.users(id) PRIMARY KEY,
  first_name TEXT,
  last_name TEXT,
  full_name TEXT,
  email TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- User learning sessions
CREATE TABLE learning_sessions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) NOT NULL,
  session_start TIMESTAMP DEFAULT NOW(),
  session_end TIMESTAMP,
  page_url TEXT,
  user_agent TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Question attempts (linked to authenticated users)
CREATE TABLE question_attempts (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  session_id UUID REFERENCES learning_sessions(id) NOT NULL,
  user_id UUID REFERENCES auth.users(id) NOT NULL, -- Direct reference for easier queries
  question_file TEXT NOT NULL,
  question_name TEXT,
  question_prefix TEXT NOT NULL,
  seed INTEGER,
  started_at TIMESTAMP DEFAULT NOW(),
  submitted_at TIMESTAMP,
  score DECIMAL,
  max_score DECIMAL,
  is_correct BOOLEAN,
  attempt_number INTEGER DEFAULT 1,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Input tracking (captures user interactions)
CREATE TABLE input_tracking (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  attempt_id UUID REFERENCES question_attempts(id) NOT NULL,
  user_id UUID REFERENCES auth.users(id) NOT NULL,
  input_name TEXT NOT NULL,
  input_value TEXT,
  input_type TEXT,
  timestamp TIMESTAMP DEFAULT NOW(),
  is_final_answer BOOLEAN DEFAULT FALSE,
  validation_result TEXT
);