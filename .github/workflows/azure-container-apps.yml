name: Deploy to Azure Container Apps

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

concurrency:
  group: stack-api-deploy
  cancel-in-progress: true

env:
  # Non-sensitive defaults (edit if your names differ)
  RESOURCE_GROUP: stack-api-rg
  LOCATION: uaenorth
  ENVIRONMENT_NAME: stack-api-env
  ACR_NAME: stackapiregistry1032
  MAXIMA_IMAGE: mathinstitut/goemaxima:2025102100-latest
  WEB_IMAGE_NAME: stack-web
  API_IMAGE_NAME: stack-api
  STACK_IMAGE_NAME: stack-backend
  WEB_CONTAINER_APP_NAME: stack-web
  API_CONTAINER_APP_NAME: stack-api
  STACK_CONTAINER_APP_NAME: stack-backend
  MAXIMA_CONTAINER_APP_NAME: stack-maxima
  IMAGE_TAG: ${{ github.run_number }}

jobs:
  build:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ACR Login (token-based)
        shell: bash
        run: |
          ACR_SERVER="${{ secrets.ACR_LOGIN_SERVER }}"
          TOKEN=$(az acr login --name "${{ env.ACR_NAME }}" --expose-token --output tsv --query accessToken)
          echo "$TOKEN" | docker login "$ACR_SERVER" -u 00000000-0000-0000-0000-000000000000 --password-stdin

      - name: Build and Push Web Image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: web/Dockerfile
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.WEB_IMAGE_NAME }}:latest
            ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.WEB_IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      - name: Build and Push API Image
        uses: docker/build-push-action@v6
        with:
          context: stackapi/api
          file: stackapi/api/Dockerfile
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.API_IMAGE_NAME }}:latest
            ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.API_IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      - name: Build and Push STACK Backend Image
        uses: docker/build-push-action@v6
        with:
          context: stackapi
          file: stackapi/Dockerfile
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.STACK_IMAGE_NAME }}:latest
            ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.STACK_IMAGE_NAME }}:${{ env.IMAGE_TAG }}

  deploy:
    name: Deploy to Azure Container Apps
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Ensure Container Apps CLI extension
        uses: azure/cli@v2
        with:
          inlineScript: |
            az extension add --name containerapp --upgrade

      - name: Deploy API Container
        uses: azure/cli@v2
        with:
          inlineScript: |
            az containerapp update \
              --name ${{ env.API_CONTAINER_APP_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --image ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.API_IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      - name: Deploy STACK Backend Container
        uses: azure/cli@v2
        with:
          inlineScript: |
            az containerapp update \
              --name ${{ env.STACK_CONTAINER_APP_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --image ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.STACK_IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      - name: Ensure Maxima CAS Container
        uses: azure/cli@v2
        with:
          inlineScript: |
            # Create or update the Maxima CAS container app
            if ! az containerapp show -n "${{ env.MAXIMA_CONTAINER_APP_NAME }}" -g "${{ env.RESOURCE_GROUP }}" > /dev/null 2>&1; then
              echo "Creating Maxima container app..."
              az containerapp create \
                --name "${{ env.MAXIMA_CONTAINER_APP_NAME }}" \
                --resource-group "${{ env.RESOURCE_GROUP }}" \
                --environment "${{ env.ENVIRONMENT_NAME }}" \
                --image "${{ env.MAXIMA_IMAGE }}" \
                --target-port 8080 \
                --ingress external \
                --min-replicas 1 \
                --max-replicas 1 \
                --env-vars GOEMAXIMA_QUEUE_LEN=32
            else
              echo "Updating Maxima container app..."
              az containerapp update \
                --name "${{ env.MAXIMA_CONTAINER_APP_NAME }}" \
                --resource-group "${{ env.RESOURCE_GROUP }}" \
                --image "${{ env.MAXIMA_IMAGE }}" \
                --set-env-vars GOEMAXIMA_QUEUE_LEN=32
            fi

      - name: Wire MAXIMA_URL into STACK Backend
        uses: azure/cli@v2
        with:
          inlineScript: |
            MAXIMA_FQDN=$(az containerapp show \
              --name "${{ env.MAXIMA_CONTAINER_APP_NAME }}" \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --query properties.configuration.ingress.fqdn \
              --output tsv)
            MAXIMA_URL="https://${MAXIMA_FQDN}/maxima"
            echo "Resolved MAXIMA_URL=${MAXIMA_URL}"
            az containerapp update \
              --name "${{ env.STACK_CONTAINER_APP_NAME }}" \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --set-env-vars MAXIMA_URL=$MAXIMA_URL

      - name: Deploy Web Container (set runtime URLs)
        uses: azure/cli@v2
        with:
          inlineScript: |
            API_FQDN=$(az containerapp show \
              --name "${{ env.API_CONTAINER_APP_NAME }}" \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --query properties.configuration.ingress.fqdn \
              --output tsv)
            STACK_FQDN=$(az containerapp show \
              --name "${{ env.STACK_CONTAINER_APP_NAME }}" \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --query properties.configuration.ingress.fqdn \
              --output tsv)
            API_BASE_URL="https://${API_FQDN}"
            STACK_BACKEND_URL="https://${STACK_FQDN}"
            echo "Resolved API_BASE_URL=$API_BASE_URL"
            echo "Resolved STACK_BACKEND_URL=$STACK_BACKEND_URL"
            az containerapp update \
              --name "${{ env.WEB_CONTAINER_APP_NAME }}" \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --image "${{ secrets.ACR_LOGIN_SERVER }}/${{ env.WEB_IMAGE_NAME }}:${{ env.IMAGE_TAG }}" \
              --set-env-vars API_BASE_URL=$API_BASE_URL STACK_BACKEND_URL=$STACK_BACKEND_URL

      - name: Get and Print Web App URL
        shell: bash
        run: |
          WEB_URL=$(az containerapp show \
            --name "${{ env.WEB_CONTAINER_APP_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --query properties.configuration.ingress.fqdn \
            --output tsv)
          echo "Application URL: https://${WEB_URL}"
